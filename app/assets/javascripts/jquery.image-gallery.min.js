(function(d){d.widget("blueimp.imagegallery",{options:{selector:'a[rel="gallery"]',namespace:"imagegallery",slideshow:0,offsetWidth:100,offsetHeight:100,fullscreen:!1,canvas:!1,bodyClass:"gallery-body",loaderId:"gallery-loader",effects:"blind,clip,drop,explode,fade,fold,puff,slide,scale".split(","),modal:!0,resizable:!1,width:"auto",height:"auto",show:"fade",hide:"fade",dialogClass:"gallery-dialog"},_scale:function(a,b){var b=b||{},c=document.createElement("canvas"),d=Math.min((b.maxWidth||a.width)/
a.width,(b.maxHeight||a.height)/a.height);1<=d&&(d=Math.max((b.minWidth||a.width)/a.width,(b.minHeight||a.height)/a.height));a.width=parseInt(a.width*d,10);a.height=parseInt(a.height*d,10);if(!b.canvas||!c.getContext)return a;c.width=a.width;c.height=a.height;c.getContext("2d").drawImage(a,0,0,a.width,a.height);return c},_getOverlay:function(){return d(document.body).children(".ui-widget-overlay").last()},_openSibling:function(a){var b=this,c=this._dialog;clearTimeout(this._slideShow);this._slideShow=
null;a.href!==this._link.href?c.dialog("widget").hide(this.options.hide,function(){b._overlay=b._getOverlay().clone().appendTo(document.body);c.dialog("option","hide",null).dialog("close");b._callback=function(){b._overlay.remove();b._overlay=null};b._open(a)}):c.dialog("close")},_prev:function(){this._openSibling(this._prevLink)},_next:function(){this._openSibling(this._nextLink)},_keyHandler:function(a){var b=a.data.imagegallery;switch(a.which){case 37:case 38:return b._prev(),!1;case 39:case 40:return b._next(),
!1}},_wheelHandler:function(a){var b=a.data.imagegallery,a=a.originalEvent;b._wheelCounter+=a.wheelDelta||a.detail||0;if(a.wheelDelta&&120<=b._wheelCounter||!a.wheelDelta&&0>b._wheelCounter)b._prev(),b._wheelCounter=0;else if(a.wheelDelta&&-120>=b._wheelCounter||!a.wheelDelta&&0<b._wheelCounter)b._next(),b._wheelCounter=0;return!1},_clickHandler:function(a){var b=a.data.imagegallery;a.altKey?b._prev():b._next()},_overlayClickHandler:function(a){a=a.data.imagegallery;d(this).unbind("click."+a.options.namespace,
a._overlayClickHandler);a._dialog.dialog("close")},_openHandler:function(a){var b=a.data.imagegallery,c=b.options;d(document.body).addClass(c.bodyClass);b._getOverlay().bind("click."+c.namespace,a.data,b._overlayClickHandler);if(b._callback)b._callback(),b._callback=null;if(c.slideshow)b._slideShow=setTimeout(function(){b._next()},c.slideshow)},_closeHandler:function(a){var a=a.data.imagegallery,b=a.options;d(document).unbind("keydown."+b.namespace,a._keyHandler).unbind("mousewheel."+b.namespace+
", DOMMouseScroll."+b.namespace,a._wheelHandler);clearTimeout(a._slideShow);a._slideShow=null;if(!a._overlay)d(document.body).removeClass(b.bodyClass),a._position=null;a._dialog.remove();a._dialog=null},_dragStopHandler:function(a,b){a.data.imagegallery._position=b.position},_initDialogHandlers:function(){var a=this.options,b={imagegallery:this};d(document).bind("keydown."+a.namespace,b,this._keyHandler).bind("mousewheel."+a.namespace+", DOMMouseScroll."+a.namespace,b,this._wheelHandler);this._dialog.bind("click."+
a.namespace,b,this._clickHandler).bind("dialogopen."+a.namespace,b,this._openHandler).bind("dialogclose."+a.namespace,b,this._closeHandler).bind("dialogdragstop."+a.namespace,b,this._dragStopHandler)},_loadHandler:function(a){var b=a.data.imagegallery,c=b.options,e=b._img&&b._img[0],f=c.offsetWidth,g=c.offsetHeight;if(e)b._dialog=d("<div></div>"),b._loaded=!0,d(document).unbind("keydown."+c.namespace,b._escapeHandler).unbind("click."+c.namespace,b._documentClickHandler),b._img=null,b._loadingAnimation.hide(),
"error"===a.type?b._dialog.addClass("ui-state-error"):(c.fullscreen&&(e=b._scale(e,{minWidth:d(window).width(),minHeight:d(window).height()}),f=g=0),e=b._scale(e,{maxWidth:d(window).width()-f,maxHeight:d(window).height()-g,canvas:c.canvas})),b._initDialogHandlers(),b._position&&(c=d.extend({},c,{position:[b._position.left,b._position.top]})),b._dialog.append(e).appendTo(document.body).dialog(c)},_abortLoading:function(){var a=this.options;this._img.unbind();d(document).unbind("keydown."+a.namespace,
this._escapeHandler).unbind("click."+a.namespace,this._documentClickHandler);this._getOverlay().remove();this._loadingAnimation.hide();d(document.body).removeClass(a.bodyClass)},_escapeHandler:function(a){27===a.keyCode&&a.data.imagegallery._abortLoading()},_documentClickHandler:function(a){var b=a.data.imagegallery;d(a.target).closest(b._link).length||b._abortLoading()},_loadImage:function(){var a=this,b=this.options,c={imagegallery:this};this._img=d("<img>");d(document).bind("keydown."+b.namespace,
c,this._escapeHandler).bind("click."+b.namespace,c,this._documentClickHandler);a._loaded=null;this._img.bind("load error",c,this._loadHandler).prop("src",this._link.href);setTimeout(function(){a._loaded||a._loadingAnimation.show()},100)},_preloadSiblings:function(){d("<img>").prop("src",this._nextLink.href);d("<img>").prop("src",this._prevLink.href)},_initSiblings:function(){var a=this,b=this._link,c=this.element.find(this.options.selector);this._nextLink=this._prevLink=null;c.each(function(d){if((c[d+
1]===b||c[d+2]===b)&&this.href!==b.href)a._prevLink=this;if((c[d-1]===b||c[d-2]===b)&&this.href!==b.href)return a._nextLink=this,!1});if(!this._prevLink)this._prevLink=c[c.length-1];if(!this._nextLink)this._nextLink=c[0]},_getRandomEffect:function(){var a=this.options.effects;return a[Math.floor(Math.random()*a.length)]},_initEffects:function(){var a=this.options;if("random"===a.show||"random"===this._show)this._show="random",a.show=this._getRandomEffect();if("random"===a.hide||"random"===this._hide)this._hide=
"random",a.hide=this._getRandomEffect()},_open:function(a){if(this._dialog){var b=d.extend({},this);b._dialog=null;b._position=null;b._open(a)}else this.options.title=a.title||decodeURIComponent(a.href.split("/").pop()),this._link=a,this._initEffects(),this._loadImage(),this._initSiblings(),this._preloadSiblings()},_initFullscreenOptions:function(){var a=this.options;a.fullscreen?(/-fullscreen$/.test(a.dialogClass)||(a.dialogClass+="-fullscreen"),/-fullscreen$/.test(a.bodyClass)||(a.bodyClass+="-fullscreen")):
(a.dialogClass=a.dialogClass.replace(/-fullscreen$/,""),a.bodyClass=a.bodyClass.replace(/-fullscreen$/,""))},_initLoadingAnimation:function(){this._loadingAnimation=d('<div id="'+this.options.loaderId+'"></div>').hide().appendTo(document.body)},_destroyLoadingAnimation:function(){this._loadingAnimation.remove();this._loadingAnimation=null},_delegate:function(){var a=this,b=this.options;this.element.delegate(b.selector,"click."+b.namespace,function(b){b.preventDefault();a._open(this)})},_undelegate:function(){this.element.undelegate(this.options.selector,
"click."+this.options.namespace)},_setOption:function(a,b){this._show=this._hide=null;var c="namespace"===a||"selector"===a;c&&this._undelegate();d.Widget.prototype._setOption.call(this,a,b);c&&this._delegate();-1!==d.inArray(a,["fullscreen","dialogClass","bodyClass"])&&this._initFullscreenOptions()},_create:function(){this._wheelCounter=0;this._initLoadingAnimation();this._initFullscreenOptions();this._delegate()},destroy:function(){clearTimeout(this._slideShow);this._slideShow=null;this._dialog&&
this._dialog.dialog("close");this._undelegate();this._destroyLoadingAnimation();d.Widget.prototype.destroy.call(this)},enable:function(){d.Widget.prototype.enable.call(this);this._delegate()},disable:function(){clearTimeout(this._slideShow);this._slideShow=null;this._undelegate();d.Widget.prototype.disable.call(this)}})})(jQuery);